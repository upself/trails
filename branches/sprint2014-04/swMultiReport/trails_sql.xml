<?xml version="1.0"?>
<sql database="trails3" object="root">
    <query name="projectSummary"
           value="select
                      sum(hw_sw) as hw_sw
                      ,sum(hw_only) as hw_only
                      ,sum(sw_only) as sw_only
                      ,sum(sw_discrep_none) as sw_discrep_none
                      ,sum(sw_discrep) as sw_discrep
                      ,account_id
                      ,account_name
                      ,account_type
                      ,account_dept
                      ,account_status
                  from
                  (
                      select
                          sum(case when hwl.id is not null and hwl.status = 'ACTIVE' and hwsw.id is not null then 1 else 0 end) as hw_sw
                          ,sum(case when hwl.id is not null and hwl.status = 'ACTIVE' and hwsw.id is null then 1 else 0 end) as hw_only
                          ,0 as sw_only
                          ,0 as sw_discrep_none
                          ,0 as sw_discrep
                          ,c.account_number as account_id
                          ,c.customer_name as account_name
                          ,t.customer_type_name as account_type
                          ,p.pod_name as account_dept
                          ,c.status as account_status
                      from
                          eaadmin.customer_type t
                          ,eaadmin.pod p
                          ,eaadmin.customer c
                          left outer join eaadmin.hardware_lpar hwl on 
                              c.customer_id = hwl.customer_id
                          left outer join eaadmin.hardware hw on 
                              hwl.hardware_id = hw.id
                          left outer join eaadmin.hw_sw_composite hwsw on 
                              hwl.id = hwsw.hardware_lpar_id
                      where
                          c.customer_type_id = t.customer_type_id
                          and c.pod_id = p.pod_id
                          and (hwl.status is null or hwl.status = 'ACTIVE')
                          and (hw.status is null or (hw.status = 'ACTIVE'
                          and (hw.hardware_status = 'ACTIVE' or hw.hardware_status = '')))
                      group by
                          c.account_number
                          ,c.customer_name
                          ,t.customer_type_name
                          ,p.pod_name
                          ,c.status

                      union all

                      select
                          0 as hw_sw
                          ,0 as hw_only
                          ,count(distinct case when swl.id is not null and swl.status = 'ACTIVE' and hwsw.id is null then swl.id else null end) as sw_only
                          ,sum(case when discrepancy_type_id = 1 then 1 else 0 end) as sw_discrep_none
                          ,sum(case when sw.id is not null then 1 else 0 end) as sw_discrep
                          ,c.account_number as account_id
                          ,c.customer_name as account_name
                          ,t.customer_type_name as account_type
                          ,p.pod_name as account_dept
                          ,c.status as account_status
                      from
                          eaadmin.customer_type t
                          ,eaadmin.pod p
                          ,eaadmin.customer c
                          left outer join eaadmin.software_lpar swl on 
                              c.customer_id = swl.customer_id
                          left outer join eaadmin.hw_sw_composite hwsw on 
                              swl.id = hwsw.software_lpar_id
                          left outer join eaadmin.installed_software sw on 
                              swl.id = sw.software_lpar_id
                      where
                          c.customer_type_id = t.customer_type_id
                          and c.pod_id = p.pod_id
                          and (swl.status is null or swl.status = 'ACTIVE')
                          and (sw.status is null or sw.status = 'ACTIVE')
                      group by
                          c.account_number
                          ,c.customer_name
                          ,t.customer_type_name
                          ,p.pod_name
                          ,c.status
                  ) as t
                  group by
                      account_id
                      ,account_name
                      ,account_type
                      ,account_dept
                      ,account_status
                  with ur">
    </query>
    <query name="bankMap"
           value="select
                      distinct b.name 
                      ,c.account_number
                  from
                      eaadmin.software_lpar sl
                      , eaadmin.installed_software isoft
                      , eaadmin.installed_signature isig
                      , eaadmin.bank_account b
                      , eaadmin.customer c
                  where 
                      isoft.software_lpar_id = sl.id
                      and isig.installed_software_id = isoft.id
                      and b.id = isig.bank_account_id
                      and c.customer_id = sl.customer_id
                      and sl.status = 'ACTIVE'
                      and isoft.status = 'ACTIVE'

                  union

                  select 
                      distinct b.name 
                      ,c.account_number
                  from
                      eaadmin.software_lpar sl
                      , eaadmin.installed_software isoft
                      , eaadmin.installed_sa_product isa
                      , eaadmin.bank_account b
                      , eaadmin.customer c
                  where 
                      isoft.software_lpar_id = sl.id
                      and isa.installed_software_id = isoft.id
                      and b.id = isa.bank_account_id 
                      and c.customer_id = sl.customer_id
                      and sl.status = 'ACTIVE'
                      and isoft.status = 'ACTIVE'

                  union

                  select 
                      distinct b.name 
                      ,c.account_number
                  from
                      eaadmin.software_lpar sl
                      , eaadmin.installed_software isoft
                      , eaadmin.installed_filter isa
                      , eaadmin.bank_account b
                      , eaadmin.customer c
                  where 
                      isoft.software_lpar_id = sl.id
                      and isa.installed_software_id = isoft.id
                      and b.id = isa.bank_account_id
                      and c.customer_id = sl.customer_id
                      and sl.status = 'ACTIVE'
                      and isoft.status = 'ACTIVE'

                  union

                  select 
                      distinct b.name 
                      ,c.account_number
                  from
                      eaadmin.software_lpar sl
                      , eaadmin.installed_software isoft
                      , eaadmin.installed_vm_product ivm
                      , eaadmin.bank_account b
                      , eaadmin.customer c
                  where 
                      isoft.software_lpar_id = sl.id
                      and ivm.installed_software_id = isoft.id
                      and b.id = ivm.bank_account_id
                      and c.customer_id = sl.customer_id
                      and sl.status = 'ACTIVE'
                      and isoft.status = 'ACTIVE'

                  union

                  select
                      distinct b.name
                      ,c.account_number
                  from
                      eaadmin.software_lpar sl
                      , eaadmin.installed_software isoft
                      , eaadmin.installed_dorana_product ivm
                      , eaadmin.bank_account b
                      , eaadmin.customer c
                  where
                      isoft.software_lpar_id = sl.id
                      and ivm.installed_software_id = isoft.id
                      and b.id = ivm.bank_account_id
                      and c.customer_id = sl.customer_id
                      and sl.status = 'ACTIVE'
                      and isoft.status = 'ACTIVE'

                  union 

                  select
                      'DISCREPANCY'
                      ,c.account_number
                  from
                      eaadmin.software_lpar sl
                      ,customer c
                  where
                      sl.status = 'ACTIVE'
                      and c.customer_id = sl.customer_id
                      and exists
                          (
                              select
                                  1
                              from
                                  eaadmin.installed_software a
                              where
                                  a.status = 'ACTIVE'
                                  and a.discrepancy_type_id = 2
                                  and a.software_lpar_id = sl.id
                          )
                 with ur">
    </query>
    <query name="getDistinctBravoCustomerIds"
           value="select
                      distinct customer_id
                  from
                      software_lpar
                  where
                      status = 'ACTIVE'
                  and customer_id not in (999999)  
                  with ur
                 ">
    </query>
</sql>
